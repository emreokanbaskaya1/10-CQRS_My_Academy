@model List<MyAcademyCQRS.Entities.Product>
@{
    ViewData["Title"] = "Ürünler";
    var categories = ViewBag.Categories as List<MyAcademyCQRS.Entities.Category> ?? new();
    var pageHeader = ViewBag.PageHeader as MyAcademyCQRS.Entities.PageHeader;
}

@if (TempData["Success"] != null) {
<div class="alert alert-success alert-dismissible fade show m-3" role="alert">@TempData["Success"]<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
}

<!-- Page Title -->
<section class="page-title" style="background-image:url(@(pageHeader?.BackgroundImageUrl ?? "/images/background/page-title.jpg"));">
    <div class="auto-container">
        <div class="content-box"><h1>@(pageHeader?.Title ?? "Ürünlerimiz")</h1>
            <ul class="bread-crumb clearfix"><li><a href="/">Ana Sayfa</a></li><li>Ürünler</li></ul>
        </div>
    </div>
</section>

<!-- Shop Section -->
<section class="shop-section sec-pad">
    <div class="auto-container">
        <div class="row clearfix">
            @foreach (var product in Model)
            {
                <div class="col-lg-3 col-md-6 col-sm-12 shop-block">
                    <div class="shop-block-one wow fadeInUp animated">
                        <div class="inner-box">
                            <figure class="image-box shop-product-image-uniform">
                                <img src="@(product.ImageUrl ?? "/images/resource/shop/product-1.jpg")" alt="@product.Name">
                                <div class="shop-cart-btn-wrapper">
                                    <form asp-action="AddToCart" asp-controller="Home" method="post" style="margin:0;">
                                        <input type="hidden" name="productId" value="@product.Id">
                                        <button type="submit" class="shop-cart-btn">
                                            <i class="fas fa-shopping-cart"></i>
                                            <span class="cart-text">Sepete Ekle</span>
                                        </button>
                                    </form>
                                </div>
                            </figure>
                            <div class="lower-content">
                                <span class="category">@product.Category?.Name</span>
                                <h4>@product.Name</h4>
                                <span class="price">₺@product.Price.ToString("N2")</span>
                                @if (!string.IsNullOrEmpty(product.Description))
                                {
                                    <p class="text-muted small mt-1">@product.Description</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

<style>
    /* Uniform shop product image styling */
    .shop-product-image-uniform {
        width: 100%;
        height: 280px;
        overflow: hidden;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f5f5f5;
    }

    .shop-product-image-uniform img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
    }

    /* Cart button wrapper positioning */
    .shop-cart-btn-wrapper {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 10;
    }

    .shop-block-one:hover .shop-cart-btn-wrapper {
        opacity: 1;
    }

    /* Shop cart button styling with text */
    .shop-cart-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: #c3935b;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: inherit;
        box-shadow: 0 4px 15px rgba(195, 147, 91, 0.3);
    }

    .shop-cart-btn:hover {
        background: #a87d4a;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(195, 147, 91, 0.4);
    }

    .shop-cart-btn .cart-text {
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
    }

    .shop-cart-btn i {
        font-size: 16px;
    }

    /* Ensure consistent card heights */
    .shop-block-one .inner-box {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .shop-block-one .lower-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
</style>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.shop-cart-btn').forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                var form = btn.closest('form');
                var formData = new FormData(form);
                var productName = btn.closest('.inner-box').querySelector('.lower-content h4').textContent;

                fetch(form.action, {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                })
                .then(function (res) { return res.json(); })
                .then(function (data) {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Sepete Eklendi!',
                            html: '<b>' + productName + '</b> sepetinize eklendi.',
                            confirmButtonText: 'Tamam',
                            confirmButtonColor: '#c3935b',
                            showCancelButton: true,
                            cancelButtonText: 'Sepete Git',
                            cancelButtonColor: '#198754'
                        }).then(function (result) {
                            if (result.dismiss === Swal.DismissReason.cancel) {
                                window.location.href = '/Home/Cart';
                            }
                        });
                    } else {
                        Swal.fire({ icon: 'error', title: 'Hata', text: data.message || 'Bir hata oluştu.', confirmButtonColor: '#c3935b' });
                    }
                })
                .catch(function () {
                    Swal.fire({ icon: 'error', title: 'Hata', text: 'İşlem sırasında bir hata oluştu.', confirmButtonColor: '#c3935b' });
                });
            });
        });
    });
</script>
}
